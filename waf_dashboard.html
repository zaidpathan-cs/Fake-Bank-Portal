<!DOCTYPE html>
<html>
<head>
    <title>WAF Dashboard - Fake Bank Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #333; color: white; padding: 20px; border-radius: 5px; }
        .nav { margin: 20px 0; }
        .nav a { margin-right: 15px; color: white; text-decoration: none; }
        .nav a:hover { text-decoration: underline; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { margin-top: 0; color: #666; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .sqli-stat { border-left: 4px solid #dc3545; }
        .xss-stat { border-left: 4px solid #ffc107; }
        .blocked-stat { border-left: 4px solid #28a745; }
        .mode-controls { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .mode-btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .learning-btn { background: #ffc107; color: #333; }
        .protection-btn { background: #dc3545; color: white; }
        .off-btn { background: #6c757d; color: white; }
        .active { border: 3px solid black; }
        .section { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .log-entry { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .sqli-log { border-left: 4px solid #dc3545; background: #ffe6e6; }
        .xss-log { border-left: 4px solid #ffc107; background: #fff3e6; }
        .blocked-log { border-left: 4px solid #28a745; background: #e6ffe6; }
        .ip-block-form { margin: 20px 0; }
        .ip-input { padding: 8px; width: 200px; margin-right: 10px; }
        .btn { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .danger-btn { background: #dc3545; }
        .success-btn { background: #28a745; }
        .timestamp { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è WAF Security Dashboard</h1>
            <p>Welcome, {{ username }}! | Fake Bank Portal Web Application Firewall</p>
            <div class="nav">
                <a href="{{ url_for('dashboard') }}">‚Üê Back to Dashboard</a>
                <a href="{{ url_for('waf.waf_test') }}">Test WAF</a>
                <a href="{{ url_for('manage_users') }}">Manage Users</a>
            </div>
        </div>

        <!-- WAF Status -->
        <div class="mode-controls">
            <h2>WAF Operation Mode</h2>
            <p>Current mode: 
                {% if protection_mode %}
                    <span style="color: #dc3545; font-weight: bold;">üîí PROTECTION MODE</span> - Blocking malicious requests
                {% elif learning_mode %}
                    <span style="color: #ffc107; font-weight: bold;">üìù LEARNING MODE</span> - Logging threats only
                {% else %}
                    <span style="color: #6c757d; font-weight: bold;">‚ö†Ô∏è DISABLED</span>
                {% endif %}
            </p>
            
            <button class="mode-btn learning-btn {% if learning_mode and not protection_mode %}active{% endif %}"
                    onclick="window.location.href='{{ url_for('waf.toggle_mode', mode='learning') }}'">
                Learning Mode
            </button>
            <button class="mode-btn protection-btn {% if protection_mode %}active{% endif %}"
                    onclick="window.location.href='{{ url_for('waf.toggle_mode', mode='protection') }}'">
                Protection Mode
            </button>
            <button class="mode-btn off-btn {% if not learning_mode and not protection_mode %}active{% endif %}"
                    onclick="window.location.href='{{ url_for('waf.toggle_mode', mode='off') }}'">
                Disable WAF
            </button>
        </div>

        <!-- Statistics -->
        <div class="section">
            <h2>Security Statistics</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Threats</h3>
                    <div class="stat-value">{{ total_threats }}</div>
                </div>
                <div class="stat-card blocked-stat">
                    <h3>Blocked Requests</h3>
                    <div class="stat-value">{{ blocked_threats }}</div>
                </div>
                {% for threat_type, count in threat_types %}
                <div class="stat-card {% if 'sql' in threat_type %}sqli-stat{% elif 'xss' in threat_type %}xss-stat{% endif %}">
                    <h3>{{ threat_type|upper }} Attempts</h3>
                    <div class="stat-value">{{ count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- IP Blocking -->
        <div class="section">
            <h2>IP Address Management</h2>
            <form action="{{ url_for('waf.block_ip') }}" method="POST" class="ip-block-form">
                <input type="text" name="ip" class="ip-input" placeholder="IP Address" required>
                <input type="text" name="reason" class="ip-input" placeholder="Reason" required>
                <button type="submit" class="btn danger-btn">Block IP</button>
            </form>
            
            <h3>Blocked IPs ({{ blocked_ips|length }})</h3>
            {% for ip in blocked_ips %}
            <div style="background: #ffe6e6; padding: 10px; margin: 5px 0; border-radius: 4px;">
                {{ ip }}
                <a href="{{ url_for('waf.unblock_ip', ip=ip) }}" 
                   onclick="return confirm('Unblock {{ ip }}?')"
                   style="float: right; background: #28a745; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px;">
                    Unblock
                </a>
            </div>
            {% else %}
            <p>No IPs currently blocked.</p>
            {% endfor %}
        </div>

        <!-- Recent Logs -->
        <div class="section">
            <h2>Recent Security Events (Last 20)</h2>
            {% if logs %}
                {% for log in logs|reverse %}
                <div class="log-entry 
                    {% if 'sql' in log.threats[0].type %}sqli-log
                    {% elif 'xss' in log.threats[0].type %}xss-log
                    {% elif log.blocked %}blocked-log{% endif %}">
                    <strong>{{ log.timestamp|datetime }}</strong> | 
                    IP: {{ log.ip }} | 
                    {{ log.method }} {{ log.path }}<br>
                    {% for threat in log.threats %}
                    <span style="color: {% if 'sql' in threat.type %}#dc3545{% elif 'xss' in threat.type %}#ffc107{% else %}#333{% endif %};">
                        {{ threat.type|upper }} detected
                    </span>
                    {% endfor %}
                    {% if log.blocked %}
                    <span style="color: #28a745; font-weight: bold;">[BLOCKED]</span>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p>No security events logged yet.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>
